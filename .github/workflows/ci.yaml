name: CI/CD Pipeline
on:
 push:
  branches: [ main ]
env:
 DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USER }}/sesion13-app
 KUBE_NAMESPACE: session13
jobs: 
 build-and-push: 
  name: Build & Push Docker Image
  runs-on: ubuntu-latest
  steps: 
  - name: Checkout code
    uses: actions/checkout@v4
  - name: Set up Python
    uses: actions/setup-python@v5
    with:
     python-version: '3.10'
  - name: Install dependencies
    run: |
     python -m pip install --upgrade pip
     pip install -r requirements.txt
  - name: Run app test
    run: python-c "import app; print('App testSuccessfull')"
  - name: Log in to Docker Hub
    uses: docker/login-action@v3
    with:
     username: ${{ secrets.DOCKERHUB_USER }}
     password: ${{ secrets.DOCKERHUB_TOKEN }}
  - name: Build and Push Docker Image
    run: |
     docker build -t $DOCKER_IMAGE:latest .
     docker push $DOCKER_IMAGE:latest
 depoly-to-k8s:
  name: Deploy to Kubernetes
  needs: build-and-push
  runs-on: ubuntu-latest
  steps:
  - name: Checkout code
    uses: actions/checkout@v4
  - name: Set up Kubectl
    uses: azure/setup-kubectl@v3
    with:
     version: 'v1.34.0'
  - name: Set Kubeconfig
    run: echo "${{ secrets.KUBECONFIG_CONTENT }}" > $HOME/.kube/config
  - name: Deploy updated image 
    run: |
     kubectl set image deployment/session13-deployment \ session13-container=$DOCKER_IMAGE:latest -n $KUBE_NAMESPACE
     kubectl rollout status deployment/session143-deployment-n $KUBE_NAMESPACE 
